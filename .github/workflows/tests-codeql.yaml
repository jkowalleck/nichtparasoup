# GitHubActions for testing
# read the docs: https://help.github.com/en/actions/configuring-and-managing-workflows/configuring-a-workflow

name: CodeQL

on:
  workflow_run:
    workflows:
      - PythonPackage Tests
      - PythonPluginExample Tests
      - WebUi Tests
    types:
      - requested

jobs:
  codeql:
    # see https://github.com/github/codeql-action
    name: CodeQL on ${{ github.event.workflow.name }}
    # disabled since it took to long
    #if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
      - name: set ENV
        run: |
          case $ISSUER_WORKFLOW_NAME in
          'PythonPackage Tests')
            echo '::set-env name=codeql-config::python-package'
            ;;
          'PythonPluginExample Tests')
            echo '::set-env name=codeql-config::python-plugin-example'
            ;;
          'WebUi Tests')
            echo '::set-env name=codeql-config::web-ui'
            ;;
          *)
            echo "::error::unconfigured ISSUER_WORKFLOW_NAME ${ISSUER_WORKFLOW_NAME}"
            exit 1
            ;;
          esac
        env:
          ISSUER_WORKFLOW_NAME: ${{ github.event.workflow.name }}
      - name: Fetch Code
        # see https://github.com/actions/checkout
        uses: actions/checkout@v2
        with:
          # We must fetch at least the immediate parents so that if this is
          # a pull request then we can checkout the head.
          fetch-depth: 2
      - run: git checkout HEAD^2
        # If this run was triggered by a pull request event, then checkout
        # the head of the pull request instead of the merge commit.
        if: ${{ github.workflow_run.event == 'pull_request' || github.workflow_run.event == 'pull_request_target' }}
      - name: Initialize CodeQL
        # see https://github.com/github/codeql-action
        uses: github/codeql-action/init@v1
        with:
          languages: python
          config-file: ./.github/codeql/${{ env.codeql-config }}.yaml
      - name: Perform CodeQL Analysis
        # see https://github.com/github/codeql-action
        uses: github/codeql-action/analyze@v1
